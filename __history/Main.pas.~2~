unit Main;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.ColorGrd,

  // Nossas Units!
  System.Generics.Collections,
  Model.Shapes,
  Editor.Canvas,
  Patterns.Commands;

type
  TFormMain = class(TForm)
    pnlToolbar: TPanel;
    btnAddCircle: TButton;
    btnAddRectangle: TButton;
    btnUndo: TButton;
    cbColor: TColorBox;
    pbCanvas: TPaintBox; // Usando TPaintBox, o componente correto para desenhar
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure btnAddCircleClick(Sender: TObject);
    procedure btnAddRectangleClick(Sender: TObject);
    procedure btnUndoClick(Sender: TObject);
    procedure pbCanvasMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure pbCanvasPaint(Sender: TObject);
  private
    { Declarações Privadas }
    // A "Engine" do nosso editor
    FDrawingCanvas: TDrawingCanvas;

    // Os protótipos para clonagem (Padrão Prototype)
    FCirclePrototype: TCircle;
    FRectanglePrototype: TRectangle;

    // A pilha para o histórico de ações (Padrão Command)
    FCommandHistory: TStack<ICommand>;

    // Guarda qual forma foi selecionada para ser adicionada no próximo clique
    FShapeToAddNext: TShape;
  public
    { Declarações Públicas }
  end;

var
  FormMain: TFormMain;

implementation

{$R *.dfm}

procedure TFormMain.FormCreate(Sender: TObject);
begin
  // Inicializa todos os nossos objetos principais
  FDrawingCanvas := TDrawingCanvas.Create;
  FCommandHistory := TStack<ICommand>.Create;

  // Cria os protótipos que serão clonados
  FCirclePrototype := TCircle.Create;
  FRectanglePrototype := TRectangle.Create;

  FShapeToAddNext := nil;
end;

procedure TFormMain.FormDestroy(Sender: TObject);
begin
  // Libera a memória dos objetos que criamos
  FDrawingCanvas.Free;
  FCommandHistory.Free;
  FCirclePrototype.Free;
  FRectanglePrototype.Free;
  FShapeToAddNext.Free; // Libera se houver uma forma pendente
end;

procedure TFormMain.btnAddCircleClick(Sender: TObject);
begin
  // Prepara uma nova forma (clonando o protótipo) para ser adicionada
  FShapeToAddNext.Free; // Libera a anterior, se houver
  FShapeToAddNext := FCirclePrototype.Clone;
  FShapeToAddNext.Color := cbColor.Selected;
  Self.Caption := 'Editor de Formas - Clique na tela para adicionar um círculo';
end;

procedure TFormMain.btnAddRectangleClick(Sender: TObject);
begin
  // Prepara uma nova forma (clonando o protótipo) para ser adicionada
  FShapeToAddNext.Free; // Libera a anterior, se houver
  FShapeToAddNext := FRectanglePrototype.Clone;
  FShapeToAddNext.Color := cbColor.Selected;
  Self.Caption := 'Editor de Formas - Clique na tela para adicionar um retângulo';
end;

procedure TFormMain.btnUndoClick(Sender: TObject);
var
  LastCommand: ICommand;
begin
  // Verifica se há algo para desfazer
  if FCommandHistory.Count > 0 then
  begin
    // 1. Pega o último comando da pilha
    LastCommand := FCommandHistory.Pop;

    // 2. Manda o comando se "desfazer"
    LastCommand.UnExecute;

    // 3. Redesenha a tela para mostrar o estado anterior
    pbCanvas.Invalidate;
    Self.Caption := 'Editor de Formas - Ação desfeita!';
  end;
end;

procedure TFormMain.pbCanvasMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
var
  Command: ICommand;
begin
  // Só faz algo se o usuário já tiver clicado em "Adicionar Círculo/Retângulo"
  if not Assigned(FShapeToAddNext) then
    Exit;

  // 1. Posiciona a nova forma onde o usuário clicou
  FShapeToAddNext.X := X - (FShapeToAddNext.Width div 2); // Centraliza no clique
  FShapeToAddNext.Y := Y - (FShapeToAddNext.Height div 2);

  // 2. Cria o objeto de COMANDO para esta ação
  Command := TAddShapeCommand.Create(FDrawingCanvas, FShapeToAddNext);

  // 3. EXECUTA o comando
  Command.Execute;

  // 4. Adiciona o comando à nossa pilha de histórico (para o Undo)
  FCommandHistory.Push(Command);

  // 5. Limpa a variável para que o próximo clique não adicione outra forma
  FShapeToAddNext := nil;

  // 6. Força a tela a se redesenhar com a nova forma
  pbCanvas.Invalidate;
  Self.Caption := 'Editor de Formas';
end;

procedure TFormMain.pbCanvasPaint(Sender: TObject);
begin
  // A propriedade Canvas do TPaintBox é PÚBLICA dentro do seu evento OnPaint.
  // É para isso que ele serve!
  FDrawingCanvas.DrawAll(pbCanvas.Canvas);
end;

end.
